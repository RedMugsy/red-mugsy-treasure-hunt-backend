// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PARTICIPANT
  PROMOTER
  ADMIN
}

enum TierType {
  FREE
  PREMIUM
  VIP
}

enum PromoterType {
  INFLUENCER
  BUSINESS
  COMMUNITY
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(PARTICIPANT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Profile information
  firstName String?
  lastName  String?
  phone     String?
  country   String?
  
  // Verification
  emailVerified    Boolean @default(false)
  emailVerifyToken String?
  resetToken       String?
  resetExpires     DateTime?

  // Relationships
  participant Participant?
  promoter    Promoter?
  payments    Payment[]
  auditLogs   AuditLog[]

  @@map("users")
}

model Participant {
  id       String @id @default(cuid())
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Registration details
  tier              TierType           @default(FREE)
  status            RegistrationStatus @default(PENDING)
  referralCode      String?
  referredBy        String? // Promoter referral code
  
  // Treasure hunt specific
  walletAddress     String?
  discordUsername   String?
  telegramUsername  String?
  
  // Metadata
  registrationData  Json? // Store additional form data
  turnstileToken    String?
  ipAddress         String?
  userAgent         String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  payments Payment[]

  @@map("participants")
}

model Promoter {
  id       String @id @default(cuid())
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Promoter details
  type              PromoterType
  status            RegistrationStatus @default(PENDING)
  referralCode      String             @unique
  
  // Business information
  companyName       String?
  website           String?
  socialMediaLinks  Json? // Store multiple social links
  
  // Platform presence
  followersCount    Int?
  engagementRate    Float?
  niche             String?
  
  // Revenue tracking
  totalReferrals    Int     @default(0)
  totalRevenue      Decimal @default(0) @db.Decimal(10, 2)
  commissionRate    Float   @default(0.1) // 10% default
  
  // Application data
  applicationData   Json? // Store application form data
  approvedBy        String? // Admin user ID
  approvedAt        DateTime?
  rejectionReason   String?
  
  // Metadata
  turnstileToken    String?
  ipAddress         String?
  userAgent         String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  referrals Referral[]

  @@map("promoters")
}

model Referral {
  id          String @id @default(cuid())
  promoterId  String
  promoter    Promoter @relation(fields: [promoterId], references: [id], onDelete: Cascade)
  
  // Referral details
  participantEmail String
  referralCode     String
  tier             TierType
  commission       Decimal @db.Decimal(10, 2)
  
  // Status tracking
  isConverted      Boolean @default(false)
  convertedAt      DateTime?
  paymentId        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("referrals")
}

model Payment {
  id             String        @id @default(cuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  participantId  String?
  participant    Participant?  @relation(fields: [participantId], references: [id])
  
  // Payment details
  stripePaymentIntentId String  @unique
  amount                Decimal @db.Decimal(10, 2)
  currency              String  @default("usd")
  tier                  TierType
  status                PaymentStatus @default(PENDING)
  
  // Stripe metadata
  stripeSessionId       String?
  stripeChargeId        String?
  receiptUrl            String?
  
  // Referral commission
  referralCode          String?
  commissionAmount      Decimal? @db.Decimal(10, 2)
  
  // Metadata
  paymentMethod         String?
  failureReason         String?
  refundReason          String?
  refundedAt            DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payments")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  // Action details
  action        String // e.g., "PARTICIPANT_APPROVED", "PAYMENT_PROCESSED"
  entityType    String // e.g., "PARTICIPANT", "PROMOTER", "PAYMENT"
  entityId      String
  
  // Changes
  oldValues     Json?
  newValues     Json?
  
  // Context
  ipAddress     String?
  userAgent     String?
  
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

model SystemConfig {
  id    String @id @default(cuid())
  key   String @unique
  value Json
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}